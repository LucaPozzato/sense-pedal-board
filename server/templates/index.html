<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Virtual Pedalboard</title>
  <!-- Programmer's Font: JetBrains Mono -->
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;700&display=swap" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    /* General Styling */
    body { 
      font-family: 'JetBrains Mono', monospace;
      text-align: center; 
      background: #222; 
      color: #fff; 
      padding: 20px;
      margin: 0;
    }
    
    h1, h3 { 
      font-weight: 300; 
      margin: 10px 0;
    }

    h1 {
      margin-top: 20px;
      margin-bottom: 20px;
    }

    h3 {
      margin-top: 30px;
      margin-bottom: 20px;
    }
    
    /* Pedal Container */
    .pedal-container { 
      display: flex; 
      flex-wrap: wrap; 
      justify-content: center; 
      gap: 10px; 
      margin-top: 20px; 
    }

    .pedal { 
      width: 130px; 
      height: 50px; 
      cursor: pointer; 
      border-radius: 8px;
      background: linear-gradient(145deg, #2a2a2a, #1e1e1e);
      box-shadow: 3px 3px 6px #111, -3px -3px 6px #333;
      text-align: center; 
      line-height: 50px; 
      font-weight: bold;
      color: #ddd;
      transition: all 0.2s ease-in-out;
    }

    .pedal:hover { 
      background: #444;
      transform: scale(1.05);
    }

    /* Pedalboard */
    .pedalboard { 
        display: flex; 
        flex-wrap: wrap; /* added to allow wrapping when images don't fit */
        justify-content: center; 
        gap: 15px; 
        margin-top: 20px;
        padding: 10px;
        background: #111;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        min-height: 100px;
    }

    /* Make pedalboard images bigger */
    .pedalboard img { 
      width: 300px; /* increased from 120px */
      height: auto; 
      transition: all 0.2s ease-in-out;
    }

    .highlight { 
      border: 3px solid #41a6ff !important; 
      box-shadow: 0px 0px 10px cyan;
      transform: scale(1.1);
    }

    /* Buttons */
    .controls { 
      margin-top: 20px;
    }

    button {
      font-family: 'JetBrains Mono', monospace;  
      background: #444; 
      color: white; 
      border: none; 
      padding: 10px 20px; 
      font-size: 16px; 
      border-radius: 6px;
      cursor: pointer;
      transition: 0.3s;
      margin: 5px;
    }

    button:hover { 
      background: #666; 
    }

    /* Slider Styling */
    input[type="range"] { 
      appearance: none;
      -webkit-appearance: none; 
      width: 200px;
      height: 8px;
      background: #555;
      border-radius: 4px;
      outline: none;
      transition: 0.2s;
    }

    input[type="range"]::-webkit-slider-thumb { 
      -webkit-appearance: none; 
      width: 20px; 
      height: 20px; 
      background: #41a6ff; 
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0px 0px 10px rgba(255, 204, 0, 0.8);
    }

    #slider-value { 
      font-size: 18px; 
      color: #41a6ff; 
      margin-left: 10px; 
      font-weight: bold; 
    }
  </style>
</head>
<body>

  <h1>SensePedalBoard</h1>

  <h3>Select a Pedal:</h3>
  <div class="pedal-container">
    <div class="pedal" data-pedal="0">Clean</div>
    <div class="pedal" data-pedal="1">Fuzz</div>
    <div class="pedal" data-pedal="2">Overdrive</div>
    <div class="pedal" data-pedal="3">Wah</div>
    <div class="pedal" data-pedal="5">Reverb</div>
    <div class="pedal" data-pedal="6">EQ</div>
    <div class="pedal" data-pedal="7">Tremolo</div>
    <div class="pedal" data-pedal="9">Ringmodulator</div>
    <div class="pedal" data-pedal="10">Synth</div>
  </div>

  <h3>Your Pedalboard:</h3>
  <div class="pedalboard"></div>

  <div class="controls">
    <button id="next-pedal">Next Pedal</button>
    <button id="clear-board">Clear Pedalboard</button>
  </div>

  <h3>Pedal Value:</h3>
  <input type="range" id="pedal-slider" min="0" max="127" value="0">
  <span id="slider-value">0</span>

  <script>
    let selectedPedals = [];
    let currentPedalIndex = 0;
    let small = false;
    let pedalNames = ["clean", "fuzz", "overdrive", "wah", "", "reverb", "equalizer", "tremolo", "", "ringmodulator", "synth"];

    // Click to add a pedal
    $(".pedal").click(function () {
      let pedalIndex = $(this).data("pedal");
      if (!selectedPedals.includes(pedalIndex)) {
        selectedPedals.push(pedalIndex);
        
        $.ajax({
          url: "/add_pedal",
          type: "POST",
          contentType: "application/json", // explicitly set the content type
          data: JSON.stringify({ pedalNumber: pedalIndex }),
          success: function(response) {
            console.log("Pedal added successfully:", response);
          },
          error: function(xhr, status, error) {
            console.error("Error adding pedal:", error);
          }
        });
      }
    });

    // Cycle through pedals
    $("#next-pedal").click(function () {
      $.get("/next_pedal", function () {
        updatePedalHighlight();
      });
    });

    // Clear pedalboard
    $("#clear-board").click(function () {
      $.get("/clear_pedal_array", function () {
        selectedPedals = [];
        $(".pedalboard").empty();
        currentPedalIndex = 0;
      });

      small = false;
      pedalboard.find('img').css('width', '300'); // reset pedal image size
    });

    // Update just the highlight without reâ€‘rendering the entire board
    function updatePedalHighlight() {
      $.get("/pedal_state", function (data) {
        let activePedal = data.active_pedal;
        $(".pedalboard img").removeClass("highlight");
        $(".pedalboard img").each(function () {
          if ($(this).data("pedal") == activePedal) {
            $(this).addClass("highlight");
          }
        });
      });
    }

    // Poll for pedal value
    function updatePedalValue() {
      $.get("/pedal_value", function (data) {
        let pedalValue = data.pedal_value;
        $("#pedal-slider").val(pedalValue);
        $("#slider-value").text(pedalValue);
      });
    }

    // Function to update the pedalboard UI based on the server state
    function updatePedalBoard() {
      $.get("/get_pedal_board", function (data) {
        let newPedalBoard = data.pedal_board;
        
        // Get current pedals displayed in the UI
        let currentPedals = $(".pedalboard img")
          .map(function() { return $(this).data("pedal"); })
          .get();

        // Only update if there's a difference
        if (JSON.stringify(currentPedals) !== JSON.stringify(newPedalBoard)) {
          $(".pedalboard").empty();
          newPedalBoard.forEach(pedalIndex => {
            const inlineStyle = small ? 'style="width:200px;height:200px;"' : '';
            $(".pedalboard").append(
              `<img src="/static/images/pedals_no_bg/${pedalNames[pedalIndex]}.png" class="pedal" data-pedal="${pedalIndex}" ${inlineStyle}>`
            );
          });
        }
        updatePedalHighlight(); // Update highlight state as needed
      });
    }

    // Slider value change
    $("#pedal-slider").on("input", function () {
      let value = $(this).val();
      $("#slider-value").text(value);
      $.post("/pedal_value", JSON.stringify({ "pedal value": value }), "json");
    });


    function adjustPedalImages() {
      const pedalboard = $('.pedalboard');
      const maxPedalboardHeight = $(window).height() * 0.45; // maximum allowed height (80% of viewport)
      const currentHeight = pedalboard.outerHeight();
      
      if (currentHeight > maxPedalboardHeight || small) {
        small = true;
        const newWidth = 200;
        const newHeight = 200;
        pedalboard.find('img').css('width', newWidth + 'px');
        pedalboard.find('img').css('height', newHeight + 'px');
      }
    }

    // Poll intervals
    setInterval(updatePedalValue, 50);
    setInterval(updatePedalBoard, 200);
    setInterval(updatePedalHighlight, 100);
    setInterval(adjustPedalImages, 200);
  </script>

</body>
</html>